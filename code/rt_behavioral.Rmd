---
title: "Reaction Time Analyses - Jones"
author: "Haroon Popal"
date: "`r Sys.Date()`"
output: html_document
---

```{r, setup, include=FALSE}
proj_dir <- '/Users/hpopal/Google Drive/My Drive/dscn_lab/projects/scon_social_reward/'

knitr::opts_knit$set(root.dir = proj_dir)
```

## Setup Up

### Import Packages
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

### Define directories
````{r}
data_dir <- 'derivatives/task_socialreward/data/'
```

### Find participants
```{r}
subj_df <- read.csv('participants.tsv', sep = '\t')

# Remove prefix from subject IDs
subj_df$participant_id<-gsub("sub-SCN","SCN_",as.character(subj_df$participant_id))

print(paste('Found ', length(subj_df$participant_id), ' participants'))
```



# Data Cleaning
```{r}
rt_data <- data.frame(matrix(ncol = 4, nrow = 0))
  
colnames(rt_data) <- c('ParticipantID', 'Run', 'ConditionName', 'Correct_RT')

# Import Data
for (subj in subj_df$participant_id) {
  # Fine data for all runs
  run_files <- Sys.glob(paste(data_dir, subj, '/*-errors.csv', sep = ''))
  
  # Loop through runs and combine into one df
  for (run_file in run_files){
    temp_run_data <- read.csv(run_file)
    if (sum(temp_run_data$redcap_v_task) == 0) {
      # Filter for relevant columns
      temp_run_data_fltr <- temp_run_data[,colnames(rt_data)]
      
      # Append to entire df
      rt_data <- rbind(rt_data, temp_run_data_fltr)
    } 
  }
}
```

Add group info to reaction time dataframe
```{r}
rt_data <- merge(rt_data, subj_df, by.x = 'ParticipantID', by.y = 'participant_id')

# Rename column
rt_data <- rt_data %>% rename_at('ParticipantID', ~'participant_id')
```

Create column for peer info
```{r}
rt_data <- rt_data %>% separate(ConditionName, c('Reward_Level', 'Condition'))
```

Make group data nominal
```{r}
rt_data$group<-gsub('1','non-autistic',as.character(rt_data$group))
rt_data$group<-gsub('2','autistic',as.character(rt_data$group))
head(rt_data)
```


## Missed trials
When a participant did not press the correct button, the feedback was "no data". This occured in two instances:
- When the participant made no button press
- When the participant hit the incorrect button, and did not hit the correct button before the trial timed out
In both these instances, the participant was not paying attention and so we should exclude these trials. If this was the case for more than 20% of the run, then we should exclude data from the entire run.

```{r}
# Find participant runs with more than 20% missed trials
exclude_subj_runs <- data.frame(participant_id = character(), Run = character(), stringsAsFactors = FALSE)

subj_list <- unique(rt_data$participant_id)

for (subj in subj_list) {
  # Filter for subject specific data
  temp_subj_data <- rt_data[rt_data$participant_id == subj, ]
  
  # Find runs per subject
  temp_runs <- unique(temp_subj_data$Run)
  
  for (run in temp_runs) {
    temp_run_rt <- temp_subj_data[temp_subj_data$Run == run, 'Correct_RT']
    
    # Calculate the percentage of missed trials
    temp_na_perc <- sum(is.na(temp_run_rt)) / length(temp_run_rt)
    
    if (temp_na_perc > 0.20) {
      exclude_subj_runs[nrow(exclude_subj_runs) + 1,] <- c(subj, run)
    }
  }
}
```

Remove participant runs
```{r}
for (i in 1:nrow(exclude_subj_runs)) {
  temp_drop_idx <- which(rt_data$participant_id == exclude_subj_runs[i, "participant_id"] & 
                         rt_data$Run == exclude_subj_runs[i, "Run"])
  
  rt_data <- rt_data[-temp_drop_idx, ]
}

```




## Check Assumptions

### Normality
```{r}
ggplot(rt_data, aes(x=Correct_RT)) + geom_histogram() + theme_classic()
```

Using method from [Jones et al., 2014](https://pubmed.ncbi.nlm.nih.gov/24550063/):
"Reaction times to the cue after the wink occurred were z-score transformed to each individual’s mean and standard deviation after first removing outliers (defined as reaction times 3 standard deviations above or below the individual’s mean reaction time) and log transforming each reaction time to satisfy normality assumptions."

```{r}
# Create copy of the data
rt_data_mod <- data.frame(rt_data)

# Remove outliers greater than 3SD
#rt_data_mod[( rt_data_mod$ParticipantID %in% "SCN_101" & rt_data_mod$Correct_RT > 3*temp_sd),]

# Log transform
rt_data_mod$Correct_RT_log <- log(rt_data$Correct_RT)

# Create empty column for log zscored data
rt_data_mod$Correct_RT_logz <- NA

for (subj in subj_df$participant_id) {
# Calculate mean and SD
  temp_subj_data <- filter(rt_data_mod, ParticipantID == subj)
  temp_mean <- mean(temp_subj_data$Correct_RT_log, na.rm = TRUE)
  temp_sd <- sd(temp_subj_data$Correct_RT_log, na.rm = TRUE)
  rt_data_mod[(rt_data_mod$ParticipantID %in% subj),'Correct_RT_logz'] <- (rt_data_mod[(rt_data_mod$ParticipantID %in% subj),'Correct_RT_log'] - temp_mean)/temp_sd
}


ggplot(rt_data_mod, aes(x=Correct_RT_logz)) + geom_histogram() + theme_classic()
```



# Reaction Time Main Effects

## Run and Reaction Time
```{r}
model_run <- lm(Correct_RT_logz ~ Run, data = rt_data_mod)
summary(model_run)
```

```{r}
ggplot(data = rt_data_mod, aes(x=Run, y=Correct_RT_logz, group=Run)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(color='black', alpha=0.05) + 
  theme_classic()
```


## Peer Category and Run Predicting Reaction Time
```{r}
model_run_peer <- lm(Correct_RT_logz ~ Run*Condition, data = rt_data_mod)
summary(model_run_peer)
```

```{r}
ggplot(data = rt_data_mod, aes(x=Condition, y=Correct_RT_logz, fill=factor(Run))) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(alpha=0.05, aes(fill=factor(Run)),
             position = position_jitterdodge(dodge.width = 0.8)) +
  theme_classic()
```



# Group Analyses

## Non-Autistic
```{r}
rt_data_mod_typ <- filter(rt_data_mod, group == 'non-autistic')
head(rt_data_mod_typ)
```

```{r}
model_run_peer_typ <- lm(Correct_RT_logz ~ Run*Condition, data = rt_data_mod_typ)
summary(model_run_peer_typ)
```

```{r}
ggplot(data = rt_data_mod_typ, aes(x=Condition, y=Correct_RT_logz, fill=factor(Run))) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(alpha=0.05, aes(fill=factor(Run)),
             position = position_jitterdodge(dodge.width = 0.8)) +
  theme_classic()
```



## Autistic
```{r}
rt_data_mod_asd <- filter(rt_data_mod, group == 'autistic')
print(length(rt_data_mod_asd$ParticipantID))
```

```{r}
model_run_peer_asd <- lm(Correct_RT_logz ~ Run*Condition, data = rt_data_mod_asd)
summary(model_run_peer_asd)
```

```{r}
ggplot(data = model_run_peer_asd, aes(x=Condition, y=Correct_RT_logz, fill=factor(Run))) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(alpha=0.05, aes(fill=factor(Run)),
             position = position_jitterdodge(dodge.width = 0.8)) +
  theme_classic()
```



# Reinforcement Learning Model
Using a Rescorla–Wagner model to model the trial-by-trial variance in participants’ reaction times. Use separate learning rates for positive and negative feedback.

## Define functions




